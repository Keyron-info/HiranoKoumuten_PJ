# invoices/serializers.py

from rest_framework import serializers
from django.contrib.auth import get_user_model
from .models import (
    Company, Department, CustomerCompany, User,
    Invoice, ApprovalRoute, ApprovalStep,
    ApprovalHistory, InvoiceComment, ConstructionSite, InvoiceItem
)

User = get_user_model()


class CompanySerializer(serializers.ModelSerializer):
    class Meta:
        model = Company
        fields = ['id', 'name', 'postal_code', 'address', 'phone', 'email', 'is_active']


class DepartmentSerializer(serializers.ModelSerializer):
    company_name = serializers.CharField(source='company.name', read_only=True)
    
    class Meta:
        model = Department
        fields = ['id', 'company', 'company_name', 'name', 'code', 'manager_name', 'is_active']


class CustomerCompanySerializer(serializers.ModelSerializer):
    business_type_display = serializers.CharField(source='get_business_type_display', read_only=True)
    
    class Meta:
        model = CustomerCompany
        fields = [
            'id', 'name', 'business_type', 'business_type_display',
            'postal_code', 'address', 'phone', 'email', 'tax_number',
            'bank_name', 'bank_branch', 'bank_account', 'is_active'
        ]


class UserSerializer(serializers.ModelSerializer):
    company_name = serializers.CharField(source='company.name', read_only=True)
    customer_company_name = serializers.CharField(source='customer_company.name', read_only=True)
    position_display = serializers.CharField(source='get_position_display', read_only=True)
    user_type_display = serializers.CharField(source='get_user_type_display', read_only=True)
    
    class Meta:
        model = User
        fields = [
            'id', 'username', 'email', 'first_name', 'last_name',
            'user_type', 'user_type_display', 'position', 'position_display',
            'company', 'company_name', 'department',
            'customer_company', 'customer_company_name',
            'phone', 'is_active_user', 'date_joined'
        ]
        read_only_fields = ['id', 'date_joined']


class UserRegistrationSerializer(serializers.ModelSerializer):
    password = serializers.CharField(write_only=True, min_length=8)
    password_confirm = serializers.CharField(write_only=True)
    
    class Meta:
        model = User
        fields = [
            'username', 'email', 'password', 'password_confirm',
            'first_name', 'last_name', 'user_type',
            'customer_company', 'phone'
        ]
    
    def validate(self, data):
        if data['password'] != data['password_confirm']:
            raise serializers.ValidationError("パスワードが一致しません")
        return data
    
    def create(self, validated_data):
        validated_data.pop('password_confirm')
        password = validated_data.pop('password')
        user = User.objects.create_user(**validated_data)
        user.set_password(password)
        user.save()
        return user


class ApprovalStepSerializer(serializers.ModelSerializer):
    approver_name = serializers.SerializerMethodField()
    position_display = serializers.CharField(source='get_approver_position_display', read_only=True)
    
    class Meta:
        model = ApprovalStep
        fields = [
            'id', 'route', 'step_order', 'step_name',
            'approver_position', 'position_display',
            'approver_user', 'approver_name',
            'is_required', 'timeout_days'
        ]
    
    def get_approver_name(self, obj):
        if obj.approver_user:
            return obj.approver_user.get_full_name()
        return '(工事現場から自動割り当て)'


class ApprovalRouteSerializer(serializers.ModelSerializer):
    steps = ApprovalStepSerializer(many=True, read_only=True)
    company_name = serializers.CharField(source='company.name', read_only=True)
    
    class Meta:
        model = ApprovalRoute
        fields = ['id', 'company', 'company_name', 'name', 'description', 'is_active', 'is_default', 'steps']


class InvoiceCommentSerializer(serializers.ModelSerializer):
    user_name = serializers.CharField(source='user.get_full_name', read_only=True)
    user_position = serializers.CharField(source='user.get_position_display', read_only=True)
    comment_type_display = serializers.CharField(source='get_comment_type_display', read_only=True)
    
    class Meta:
        model = InvoiceComment
        fields = [
            'id', 'invoice', 'user', 'user_name', 'user_position',
            'comment_type', 'comment_type_display',
            'comment', 'is_private', 'timestamp'
        ]
        read_only_fields = ['id', 'user', 'timestamp']


class ApprovalHistorySerializer(serializers.ModelSerializer):
    user_name = serializers.CharField(source='user.get_full_name', read_only=True)
    user_position = serializers.CharField(source='user.get_position_display', read_only=True)
    action_display = serializers.CharField(source='get_action_display', read_only=True)
    step_name = serializers.CharField(source='approval_step.step_name', read_only=True, allow_null=True)
    
    class Meta:
        model = ApprovalHistory
        fields = [
            'id', 'invoice', 'approval_step', 'step_name',
            'user', 'user_name', 'user_position',
            'action', 'action_display',
            'comment', 'timestamp'
        ]
        read_only_fields = ['id', 'user', 'timestamp']


class ConstructionSiteSerializer(serializers.ModelSerializer):
    """工事現場シリアライザー"""
    company_name = serializers.CharField(source='company.name', read_only=True)
    supervisor_name = serializers.CharField(source='supervisor.get_full_name', read_only=True, allow_null=True)
    
    class Meta:
        model = ConstructionSite
        fields = [
            'id', 'name', 'location', 
            'company', 'company_name',
            'supervisor', 'supervisor_name',
            'is_active', 'created_at'
        ]
        read_only_fields = ['id', 'created_at']


class InvoiceItemSerializer(serializers.ModelSerializer):
    """請求明細シリアライザー"""
    
    class Meta:
        model = InvoiceItem
        fields = [
            'id', 'item_number', 'description', 
            'quantity', 'unit', 'unit_price', 'amount'
        ]
        read_only_fields = ['id', 'amount']


class InvoiceCreateSerializer(serializers.ModelSerializer):
    """請求書作成用シリアライザー"""
    items = InvoiceItemSerializer(many=True)
    
    class Meta:
        model = Invoice
        fields = [
            'construction_site', 'project_name', 'invoice_date',
            'payment_due_date', 'notes', 'items'
        ]
    
    def create(self, validated_data):
        items_data = validated_data.pop('items')
        
        # リクエストユーザーの情報を取得
        user = self.context['request'].user
        
        # created_byを設定
        validated_data['created_by'] = user
        
        # customer_companyを自動設定（協力会社ユーザーの場合）
        if user.user_type == 'customer' and user.customer_company:
            validated_data['customer_company'] = user.customer_company
        
        # receiving_company を自動設定
        from .models import Company
        receiving_company = Company.objects.first()
        if receiving_company:
            validated_data['receiving_company'] = receiving_company
        
        # invoiceを作成
        invoice = Invoice.objects.create(**validated_data)
        
        # 明細を作成
        for item_data in items_data:
            InvoiceItem.objects.create(invoice=invoice, **item_data)
        
        # 金額計算
        invoice.calculate_totals()
        
        return invoice


class InvoiceListSerializer(serializers.ModelSerializer):
    """請求書一覧用シリアライザー（軽量版）"""
    customer_company_name = serializers.CharField(source='customer_company.name', read_only=True)
    construction_site_name_display = serializers.SerializerMethodField()
    status_display = serializers.CharField(source='get_status_display', read_only=True)
    created_by_name = serializers.CharField(source='created_by.get_full_name', read_only=True)
    current_approver_name = serializers.CharField(source='current_approver.get_full_name', read_only=True, allow_null=True)
    template_name = serializers.CharField(source='template.name', read_only=True, allow_null=True)
    period_name = serializers.CharField(source='invoice_period.period_name', read_only=True, allow_null=True)
    custom_values = CustomFieldValueSerializer(many=True, read_only=True)
    
    class Meta:
        model = Invoice
        fields = [
            'id', 'invoice_number', 
            'customer_company_name',
            'construction_site_name_display',
            'project_name', 'invoice_date', 'payment_due_date',
            'status', 'status_display',
            'total_amount',
            'current_approver_name',
            'created_by_name',
            'created_at', 'updated_at',
            'template', 'template_name',
            'invoice_period', 'period_name',
            'custom_values',
        ]
    
    def get_construction_site_name_display(self, obj):
        """工事現場名を取得（construction_site_nameまたはconstruction_site.name）"""
        if obj.construction_site_name:
            return obj.construction_site_name
        elif obj.construction_site:
            return obj.construction_site.name
        return ''


class InvoiceSerializer(serializers.ModelSerializer):
    """請求書詳細シリアライザー"""
    items = InvoiceItemSerializer(many=True, read_only=True)
    customer_company_name = serializers.CharField(source='customer_company.name', read_only=True)
    construction_site_name_display = serializers.SerializerMethodField()
    status_display = serializers.CharField(source='get_status_display', read_only=True)
    created_by_name = serializers.CharField(source='created_by.get_full_name', read_only=True)
    current_approver_name = serializers.CharField(source='current_approver.get_full_name', read_only=True, allow_null=True)
    current_step_name = serializers.CharField(source='current_approval_step.step_name', read_only=True, allow_null=True)
    comments = InvoiceCommentSerializer(many=True, read_only=True)
    approval_histories = ApprovalHistorySerializer(many=True, read_only=True)
    approval_route_detail = ApprovalRouteSerializer(source='approval_route', read_only=True)
    # Phase 2: 追加
    template_name = serializers.CharField(source='template.name', read_only=True, allow_null=True)
    period_name = serializers.CharField(source='invoice_period.period_name', read_only=True, allow_null=True)
    custom_values = CustomFieldValueSerializer(many=True, read_only=True)
    
    class Meta:
        model = Invoice
        fields = [
            'id', 'invoice_number', 
            'customer_company', 'customer_company_name',
            'construction_site', 'construction_site_name_display',
            'project_name', 'invoice_date', 'payment_due_date',
            'status', 'status_display',
            'subtotal', 'tax_amount', 'total_amount',
            'notes', 'items',
            'approval_route', 'approval_route_detail',
            'current_approval_step', 'current_step_name',
            'current_approver', 'current_approver_name',
            'created_by', 'created_by_name',
            'created_at', 'updated_at',
            'comments', 'approval_histories'
            'template', 'template_name',
            'invoice_period', 'period_name',
            'custom_values',
        ]
        read_only_fields = [
            'id', 'invoice_number', 'subtotal', 'tax_amount', 'total_amount',
            'created_by', 'created_at', 'updated_at'
        ]
    
    def get_construction_site_name_display(self, obj):
        """工事現場名を取得"""
        if obj.construction_site_name:
            return obj.construction_site_name
        elif obj.construction_site:
            return obj.construction_site.name
        return ''
    # ==========================================
# Phase 2: シリアライザー追加
# ==========================================
# backend/invoices/serializers.py に追加してください

from rest_framework import serializers
from .models import (
    InvoiceTemplate, TemplateField, MonthlyInvoicePeriod,
    CustomField, CustomFieldValue, PDFGenerationLog
)


# ==========================================
# 1. テンプレート関連
# ==========================================

class TemplateFieldSerializer(serializers.ModelSerializer):
    """テンプレートフィールドシリアライザー"""
    
    class Meta:
        model = TemplateField
        fields = [
            'id', 'field_name', 'field_type', 'is_required',
            'default_value', 'display_order', 'help_text', 'choices'
        ]


class InvoiceTemplateSerializer(serializers.ModelSerializer):
    """請求書テンプレートシリアライザー"""
    fields = TemplateFieldSerializer(many=True, read_only=True)
    company_name = serializers.CharField(source='company.name', read_only=True)
    
    class Meta:
        model = InvoiceTemplate
        fields = [
            'id', 'name', 'company', 'company_name', 'description',
            'is_active', 'is_default', 'fields', 'created_at', 'updated_at'
        ]
        read_only_fields = ['created_at', 'updated_at']


class InvoiceTemplateListSerializer(serializers.ModelSerializer):
    """テンプレート一覧用（軽量版）"""
    company_name = serializers.CharField(source='company.name', read_only=True)
    field_count = serializers.SerializerMethodField()
    
    class Meta:
        model = InvoiceTemplate
        fields = [
            'id', 'name', 'company_name', 'is_active', 'is_default',
            'field_count', 'created_at'
        ]
    
    def get_field_count(self, obj):
        return obj.fields.count()


# ==========================================
# 2. 月次請求期間管理
# ==========================================

class MonthlyInvoicePeriodSerializer(serializers.ModelSerializer):
    """月次請求期間シリアライザー"""
    company_name = serializers.CharField(source='company.name', read_only=True)
    closed_by_name = serializers.CharField(source='closed_by.get_full_name', read_only=True, allow_null=True)
    period_name = serializers.CharField(read_only=True)
    is_past_deadline = serializers.BooleanField(read_only=True)
    
    # 統計情報
    total_invoices = serializers.SerializerMethodField()
    submitted_invoices = serializers.SerializerMethodField()
    pending_invoices = serializers.SerializerMethodField()
    
    class Meta:
        model = MonthlyInvoicePeriod
        fields = [
            'id', 'company', 'company_name', 'year', 'month',
            'deadline_date', 'is_closed', 'closed_by', 'closed_by_name',
            'closed_at', 'notes', 'period_name', 'is_past_deadline',
            'total_invoices', 'submitted_invoices', 'pending_invoices',
            'created_at'
        ]
        read_only_fields = ['closed_by', 'closed_at', 'created_at']
    
    def get_total_invoices(self, obj):
        """この期間の総請求書数"""
        return obj.invoices.count()
    
    def get_submitted_invoices(self, obj):
        """提出済み請求書数"""
        return obj.invoices.exclude(status='draft').count()
    
    def get_pending_invoices(self, obj):
        """未提出（下書き）請求書数"""
        return obj.invoices.filter(status='draft').count()


class MonthlyInvoicePeriodListSerializer(serializers.ModelSerializer):
    """月次期間一覧用（軽量版）"""
    period_name = serializers.CharField(read_only=True)
    status_display = serializers.SerializerMethodField()
    
    class Meta:
        model = MonthlyInvoicePeriod
        fields = [
            'id', 'year', 'month', 'period_name', 'deadline_date',
            'is_closed', 'status_display'
        ]
    
    def get_status_display(self, obj):
        if obj.is_closed:
            return '締め済み'
        elif obj.is_past_deadline:
            return '締切超過'
        else:
            return '受付中'


# ==========================================
# 3. カスタムフィールド
# ==========================================

class CustomFieldSerializer(serializers.ModelSerializer):
    """カスタムフィールドシリアライザー"""
    
    class Meta:
        model = CustomField
        fields = [
            'id', 'company', 'field_name', 'field_type',
            'is_required', 'is_active', 'display_order', 'help_text'
        ]


class CustomFieldValueSerializer(serializers.ModelSerializer):
    """カスタムフィールド値シリアライザー"""
    field_name = serializers.CharField(source='custom_field.field_name', read_only=True)
    field_type = serializers.CharField(source='custom_field.field_type', read_only=True)
    
    class Meta:
        model = CustomFieldValue
        fields = ['id', 'custom_field', 'field_name', 'field_type', 'value']


# ==========================================
# 4. PDF生成履歴
# ==========================================

class PDFGenerationLogSerializer(serializers.ModelSerializer):
    """PDF生成履歴シリアライザー"""
    generated_by_name = serializers.CharField(source='generated_by.get_full_name', read_only=True, allow_null=True)
    invoice_number = serializers.CharField(source='invoice.invoice_number', read_only=True)
    
    class Meta:
        model = PDFGenerationLog
        fields = [
            'id', 'invoice', 'invoice_number', 'generated_by',
            'generated_by_name', 'generated_at', 'file_size'
        ]
        read_only_fields = ['generated_at']


# ==========================================
# 5. 既存InvoiceSerializerへの追加
# ==========================================
# ※ 既存のInvoiceSerializerに以下のフィールドを追加してください

# class InvoiceSerializer(serializers.ModelSerializer):
#     # 既存のフィールド...
#     
#     # Phase 2: 追加フィールド
#     template_name = serializers.CharField(source='template.name', read_only=True, allow_null=True)
#     period_name = serializers.CharField(source='invoice_period.period_name', read_only=True, allow_null=True)
#     custom_values = CustomFieldValueSerializer(many=True, read_only=True)
#     
#     class Meta:
#         model = Invoice
#         fields = [
#             # ... 既存のフィールド ...
#             'template', 'template_name',
#             'invoice_period', 'period_name',
#             'custom_values',
#         ]