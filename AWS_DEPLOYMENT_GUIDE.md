# AWSデプロイ手順書 (App Runner + S3/CloudFront構成)

このドキュメントでは、作成したアプリケーションをAWS（Amazon Web Services）にデプロイ（公開）するための手順を解説します。

---

## 構成概要

-   **バックエンド (Django)**: **AWS App Runner**
    -   Dockerコンテナを自動で実行・管理してくれるサービスです。
-   **データベース**: **Amazon RDS for PostgreSQL**
    -   管理されたリレーショナルデータベースサービスです。
-   **フロントエンド (React)**: **Amazon S3 + CloudFront**
    -   静的ファイルホスティングとCDN（コンテンツ配信ネットワーク）です。

---

## 事前準備

1.  **AWSアカウント**: AWSのコンソールにログインできる状態にしてください。
2.  **GitHubアカウント**: ソースコードをGitHubにプッシュしてある必要があります（App RunnerがGitHubと連携するため）。

---

## 手順1: データベース (RDS) の作成

1.  AWSコンソールで「**RDS**」を検索し、開きます。
2.  「**データベースの作成**」をクリック。
3.  **エンジンのオプション**: `PostgreSQL` を選択。
4.  **テンプレート**: 本番稼働なら`本番稼働用`、テストなら`開発/テスト`または`無料利用枠`を選択。
5.  **設定**:
    -   DBインスタンス識別子: `keyron-db` (任意)
    -   マスターユーザー名: `keyron_user` (任意)
    -   マスターパスワード: 強力なパスワードを設定してください (忘れないようにメモ！)
6.  **接続**:
    -   「パブリックアクセス可能」は `なし` (セキュリティのため推奨ですが、PCから直接つなぐ場合は一時的にありにする必要があります。App RunnerからはVPC接続設定が必要になりますが、最初は簡単のため `あり` にしてIP制限をかけるか、**App RunnerのVPCコネクタ**を使用するのが正攻法です。今回は**App RunnerのVPCアクセス**を使います)
7.  「**データベースの作成**」をクリック（作成に数分かかります）。

---

## 手順2: バックエンド (App Runner) のデプロイ

1.  AWSコンソールで「**App Runner**」を検索し、開きます。
2.  「**App Runner サービスを作成**」をクリック。
3.  **ソース**:
    -   リポジトリタイプ: `ソースコードリポジトリ`
    -   プロバイダー: `GitHub` (連携設定を行ってください)
    -   リポジトリ: 対象のリポジトリを選択
    -   ブランチ: `main` (デプロイしたいブランチ)
    -   デプロイ設定: `自動` (GitHubにプッシュすると自動デプロイされます)
4.  **ビルド設定**:
    -   ランタイム: `Python 3`
    -   ビルドコマンド: `pip install -r requirements.txt && python manage.py collectstatic --noinput`
    -   開始コマンド: `gunicorn --bind 0.0.0.0:8000 keyron_project.wsgi:application`
    -   ポート: `8000`
5.  **サービス設定**:
    -   サービス名: `keyron-backend`
    -   **環境変数** (「環境変数を追加」から設定):
        -   `SECRET_KEY`: (ランダムな長い文字列)
        -   `DEBUG`: `False`
        -   `ALLOWED_HOSTS`: `*` (後でドメインが決まったら変更)
        -   `DATABASE_URL`: `postgres://ユーザー名:パスワード@エンドポイント:5432/postgres` (RDSのエンドポイントを確認して入力)
6.  **ネットワーク (重要)**:
    -   送信トラフィック: `カスタムVPC` を選択し、**VPCコネクターを追加**を作成します（RDSと同じVPCを選択）。これによりApp RunnerがRDSに接続できるようになります。
7.  「**作成とデプロイ**」をクリック。
    -   しばらくするとデプロイが完了し、`https://xxxxxx.awsapprunner.com` のようなURLが発行されます。これが**バックエンドのURL**です。

---

## 手順3: フロントエンド (AWS Amplify) のデプロイ

フロントエンドは「AWS Amplify」を使うのが最も簡単でおすすめです。GitHubと連携するだけで、自動的にビルド・公開してくれます。

1.  AWSコンソールで「**AWS Amplify**」を検索し、開きます。
2.  「**新しいアプリを作成**」を選択（または「ウェブアプリケーションをホスト」）。
3.  **既存のコードから開始**: `GitHub` を選択して「次へ」。
4.  **リポジトリの追加**:
    -   GitHub認証を行い、`HiranoKoumuten_PJ` (今回のリポジトリ) を選択。
    -   ブランチ: `main`
5.  **ビルド設定**:
    -   Amplifyが自動的に `React` アプリであることを検出し、設定を提案してくれます。基本そのままでOKです。
    -   **重要**: 環境変数を設定する必要があります。「詳細設定」を開き、環境変数を追加します。
        -   キー: `REACT_APP_API_URL`
        -   値: `https://(手順2で発行されたApp RunnerのURL)`
6.  「**次へ**」→「**保存してデプロイ**」をクリック。
    -   自動的にビルドが始まり、数分で完了します。
7.  完了すると `https://xxx.amplifyapp.com` というURLが発行されます。これがアプリケーションのURLです。

---

## 手順4: 最終確認

1.  AmplifyのURL (`https://xxx.amplifyapp.com`) にアクセスします。
2.  ログイン画面が表示されることを確認します。
3.  バックエンドとの通信（ログインなど）が成功するか確認します。
    -   失敗する場合、CORSエラーの可能性があります。App Runnerの「設定」→「環境変数」で `CORS_ALLOWED_ORIGINS` を編集し、AmplifyのURLを追加してください（カンマ区切り）。
        -   例: `http://localhost:3000,https://main.xxx.amplifyapp.com`


以上でデプロイは完了です！
